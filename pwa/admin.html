<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="http://localhost/proyectoFinal/pwa/img/favicon.png">

    <title>TurApp</title>
    <meta name="description" content="PWA del proyecto final de la tesis hecha para los usuarios guías de la app">

    <meta name="TurApp" content="#dddddd">
    <meta name="theme-color" content="black">

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">


    <link href="../assets/vendor/quill/quill.snow.css" rel="stylesheet">
    <link href="../assets/vendor/quill/quill.bubble.css" rel="stylesheet">

    <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">

</head>
<body>
    

    <main class="">
        <div class="tab-content" id="contentTab">

            <!-- ------------------------------- -->
            <!--            RECORRIDOS           -->
            <!-- ------------------------------- -->
            <div class="tab-pane fade show active" id="recorrido" role="tabpanel" aria-labelledby="recorrido-tab">
                <h2 class="colorTitle fw-bold mb-3"><i class="bi bi-bus-front me-1"></i>Salidas</h2>

                <div class="form-floating">
                    <input type="date" name="fechaSalida" id="fechaSalida" class="form-control form-control-sm" value="">
                    <label for="fechaSalida" class="mb-1">Fecha de salida</label>
                </div>

                <button type="button" class="btn btn-primary btn-sm mt-2 w-100" onclick="filtrarSalidas()"><i class="bi bi-funnel-fill me-1"></i>Filtrar salidas</button>

                <div class="mt-3" id="contentSalidas">
                    
                </div>
            </div>

            <!-- --------------------------- -->
            <!--        Editar perfil        -->
            <!-- --------------------------- -->
            <div class="tab-pane fade show " id="perfil" role="tabpanel" aria-labelledby="perfil-tab">
                
                <h2 class="colorTitle fw-bold mb-3"><i class="bi bi-person-fill me-1"></i>Perfil</h2>

                <form id="formProfile">

                    <div class="mb-3 row">
                        <div class="col-6">
                            <label for="nombre" class="">Nombre</label>
                            <input name="nombre" type="text" class="form-control form-control-sm" id="nombre">
                        </div>
                        <div class="col-6">
                            <label for="apellido" class="">Apellido</label>
                            <input name="apellido" type="text" class="form-control form-control-sm" id="apellido">
                        </div>
                    </div>

                    <div class="mb-3 row">
                        <div class="col-6">
                            <label for="email" class="">Email</label>
                            <input name="email" type="email" class="form-control form-control-sm" id="email">
                        </div>
                        <div class="col-6">
                            <label for="password">Contraseña <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-html="true" title="<b>Si completa este campo cambiará su contraseña actual.</b><br>Recuerde que debe tener una minuscula, una mayuscula, un numero, un caracter especial y 8 dígitos"></i></label>
                            <input type="password" class="form-control form-control-sm" name="password" id="password">
                        </div>
                    </div>


                    <div class="mb-3">
                        <label for="Country" class="">Teléfono</label>
                        <div class="input-group">
                            <input type="tel" name="codPais" id="codPais" class="form-control form-control-sm">
                            <input type="tel" name="codArea" id="codArea" class="form-control form-control-sm">
                            <input type="tel" name="telefono" id="telefono" class="form-control form-control-sm">
                        </div>
                        <small class="text-secondary">Cod país + Cod área + Número</small>
                    </div>


                    <div class="mb-3 row">
                        <div class="col-6">
                            <label for="dni" class="">DNI</label>
                            <input name="dni" type="number" class="form-control form-control-sm" id="dni">
                        </div>
                        <div class="col-6">
                            <label for="fechaNacimiento" class="">Fech. nacimiento</label>
                            <input name="fechaNacimiento" type="date" class="form-control form-control-sm" id="fechaNacimiento">
                        </div>
                    </div>


                    <div class="mb-3 row">
                        <div class="col-6">
                            <label for="nacionalidad" class="">Nacionalidad</label>
                            <input name="nacionalidad" type="text" class="form-control form-control-sm" id="nacionalidad">
                        </div>
                        <div class="col-6">
                            <label for="sexo" class="">Sexo</label>
                            <input name="sexo" type="text" class="form-control form-control-sm" id="sexo">
                        </div>
                    </div>


                    <hr class="mb-2">
                    <div class="contentAbout mb-3">
                        <p class="text-center mb-2 mt-0"><label for="">Sobre mí</label></p>
                        <div id="about"></div>
                    </div>
                    
                    <div class="d-grid gap-1">
                        <button type="button" class="btn btn-primary btn-sm" onclick="handlerSaveProfile(this)"><i class="fa fa-save me-1"></i>Guardar cambios</button>
                    </div>
                </form><!-- End Profile Edit Form -->

            </div>
        </div>
    </main>



    <!-- --------------------------------- -->
    <!--        Barra de navegación        -->
    <!-- --------------------------------- -->
    <footer class="row m-0 text-center nav nav-tabs" role="tablist" id="tabFooter">
        <div class="nav-item col-5" role="presentation">
            <button type="button" id="recorrido-tab" class="nav-link btn btn-primary active" data-bs-toggle="tab" data-bs-target="#recorrido" role="tab" aria-controls="recorrido" aria-selected="true"><i class="bi bi-bus-front"></i></button>
        </div>
        <div class="nav-item col-2 footer__contentIconPerfil" role="presentation">
            <button type="button" id="perfil-tab" class="nav-link btn btn-primary " data-bs-toggle="tab" data-bs-target="#perfil" role="tab" aria-controls="perfil" aria-selected="false"><i class="bi bi-person-fill"></i></button>
        </div>
        <div class="col-5 footer__contentIconLogout">
            <button type="button" class="" onclick="logout()"><i class="bi bi-box-arrow-right"></i></button>
        </div>
    </footer>



    <!-- Bootstrap 5 -->
    <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Alert 2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Textarea editor -->
    <script src="../assets/vendor/quill/quill.js"></script>

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/deecb3ce02.js" crossorigin="anonymous"></script>

    <!-- Main Javascript -->
    <script src="assets/js/main.js"></script>

    <script>
        const user = JSON.parse(localStorage.getItem("user"))
        let textareaEditor = null
        
        document.addEventListener("DOMContentLoaded", e => {
            // Data user
            console.log(user)
            
            // Perfil
            perfil_initForm()

            // Salidas
            filtrarSalidas()

        })

        /* ----------------- */
        /*      PERFIL       */
        /* ----------------- */
        function perfil_initForm(){
            document.getElementById("nombre").value = user.nombre
            document.getElementById("apellido").value = user.apellido
            document.getElementById("email").value = user.email
            document.getElementById("codPais").value = user.codPais
            document.getElementById("codArea").value = user.codArea
            document.getElementById("telefono").value = user.telefono
            document.getElementById("dni").value = user.dni
            document.getElementById("fechaNacimiento").value = user.fechaNacimiento
            document.getElementById("nacionalidad").value = user.nacionalidad
            document.getElementById("sexo").value = user.sexo
            document.getElementById("about").innerHTML = decodeHtmlEntities(user.descripcion)

            textareaEditor = new TextareaEditor("#about")
            textareaEditor.initBasicText()
        }

        function handlerSaveProfile(el){
            const htmlBtnOrigin = el.innerHTML

            el.disabled = true

            Swal.fire({
                title: "¿Estás seguro?",
                text: "",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Si",
                cancelButtonText: "No"
            }).then(result => {
                if (!result.isConfirmed){
                    el.disabled = false
                    return
                }

                el.innerHTML = "Guardando..."

                let formData = new FormData(document.getElementById("formProfile"))
                formData.append("descripcion", textareaEditor.getHTML());
                formData.append("table", "usuarios");
                formData.append("pk", "idUsuario");
                formData.append("idUsuario", user.idUsuario);
                formData.append("action", "perfil_edit");


                fetch(
                    "process.php", 
                    {
                        method: "POST",
                        body: formData,
                    }
                )
                .then(result => result.json())
                .then(response => {
                    el.innerHTML = htmlBtnOrigin
                    el.disabled = false

                    const Toast = Swal.mixin({
                        toast: true,
                        position: "bottom-end",
                        showConfirmButton: false,
                        timer: response.status === "OK" ? 1000 : 3000,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;
                        },
                    });
                    Toast.fire({
                        icon: response.type,
                        title: response.title,
                        text: response.message,
                    });

                    // Actualizo sus datos
                    if(response.status === "OK") localStorage.setItem("user", JSON.stringify(response.user))
                })
            })
        }


        /* ----------------- */
        /*      Salidas      */
        /* ----------------- */
        function filtrarSalidas(){
            const fechaSalida = document.getElementById("fechaSalida").value
            const formData = new FormData()
            formData.append("fechaSalida", fechaSalida)
            formData.append("idUsuario", user.idUsuario)
            formData.append("action", "recorrido_salidas")

            fetch(
                "process.php", 
                {
                    method: "POST",
                    body: formData,
                }
            )
            .then(result => result.json())
            .then(response => {
                console.log(response)
                let contentSalidas = document.getElementById("contentSalidas")

                if(response.salidas.length == 0){
                    contentSalidas.innerHTML = `<h5 class="d-flex justify-content-center align-items-center" style="height: 500px;">Sin salidas disponibles</h5>`
                    return
                }

                let htmlCardSalidas = ""
                for (const salida of response.salidas) {
                    htmlCardSalidas += getHTMLItemSalida(salida)
                }

                contentSalidas.innerHTML = htmlCardSalidas
            })
        }

        function getHTMLItemSalida(data){
            let [anioSalida, mesSalida, diaSalida] = data.fecha.split("-")
            const fechaSalida = `${diaSalida}/${mesSalida}/${anioSalida}`
            const horaSalida= data.horaSalida.substring(0,5) 

            return `
                <div class="mb-3 card shadow-sm border">
                    <a href="detalleSalida.html?idRecorrido=${data.idRecorrido}" class="text-default color-hover-none">
                        <div class="card-header">
                            <p class="m-0 h1 text-center">${fechaSalida} <span class="h6">${horaSalida}hs</span></p>
                        
                        </div>
                        <div class="card-body">
                            <p class="m-0 h1 mb-2">${data.titulo}</p>
                            <p class="m-0"><i class="bi bi-globe-americas me-1"></i>${data.provincia}, ${data.destino}</p>
                            <p class="m-0"><i class="bi bi-people me-1"></i>${data.pasajeros} pasajero${(data.pasajeros > 1 ? "s" : "")}</p>
                        </div>
                    </a>
                </div>
            `
        }
    </script>
</body>
</html>

