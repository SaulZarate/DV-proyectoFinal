<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="http://localhost/proyectoFinal/pwa/img/favicon.png">

    <title>TurApp</title>
    <meta name="description" content="PWA del proyecto final de la tesis hecha para los usuarios guías de la app">

    <meta name="TurApp" content="#dddddd">
    <meta name="theme-color" content="black">

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">


    <link href="../assets/vendor/quill/quill.snow.css" rel="stylesheet">
    <link href="../assets/vendor/quill/quill.bubble.css" rel="stylesheet">

    <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">

</head>
<body class="fullScreen">
    

    <header class="mb-3">
        <a href="admin.html" class="fs-3 m-0 text-default"><i class="bi bi-arrow-left"></i></a>
    </header>

    <main>
        
        <!-- -------------------- -->
        <!--        Header        -->
        <!-- -------------------- -->
        <!-- <section class="cardMobile mb-3">
            <h5 class="colorTitle h4 fw-bold m-0"><i class="bi bi-bus-front me-1"></i>Detalle del recorrido</h5>
            <p class="text-secondary pb-0 mb-2">Esta vista contiene información detallada sobre el recorrido</p>

            <button class="btn btn-primary btn-sm mb-1" type="button" onclick="handlerRefreshRecorrido()"><i class="bi bi-arrow-repeat me-1"></i>Actualizar recorrido</button>

            <button type="button" class="btn btn-success btn-sm mb-1" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMensajes" aria-controls="offcanvasMensajes"><i class="bi bi-chat-right-text me-1"></i>Chat general</button>
        </section> -->

        <!-- ----------------------------------- -->
        <!--        Detalle de la excursión      -->
        <!-- ----------------------------------- -->
        <section class="cardMobile mb-3 p-0" id="detalleExcursion"></section>


        <!-- ---------------- -->
        <!--        Mapa      -->
        <!-- ---------------- -->
        <section class="mb-3" id="contentMapa"></section>
        
        <!-- ------------------ -->
        <!--        Tramos      -->
        <!-- ------------------ -->
        <section class="mb-3" id="contentTramos"></section>

    </main>



    <!-- Bootstrap 5 -->
    <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Alert 2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Textarea editor -->
    <script src="../assets/vendor/quill/quill.js"></script>

    <!-- Main Javascript -->
    <script src="assets/js/main.js"></script>

    <script>
        const user = JSON.parse(localStorage.getItem("user"))
        const paramsURL = getVarGET()
        let dataRecorrido = null

        document.addEventListener("DOMContentLoaded", e => {
            
            getDataRecorrido()
        })
        
        /* ----------------------------- */
        /*          Mis funciones        */
        /* ----------------------------- */
        function getDataRecorrido(){
            const formData = new FormData()
            formData.append("idRecorrido", paramsURL.idRecorrido)
            formData.append("action", "recorrido_getInfo")

            fetch(
                "process.php", 
                {
                    method: "POST",
                    body: formData,
                }
            )
            .then(result => result.json())
            .then(response => {
                dataRecorrido = response.recorrido

                document.getElementById("detalleExcursion").innerHTML = getHTMLDetallePaquete(dataRecorrido)

                // Si no tiene paradas no muestro nada más
                if(dataRecorrido.totalAlojamientoConsulta == 0) return

                // Muestro el mapa
                const divContentMapa = document.getElementById("contentMapa")
                divContentMapa.innerHTML = `
                    <iframe src="../admin/alojamientos/map.readonly.multiple.iframe.php?idRecorrido=${dataRecorrido.idRecorrido}" frameborder="0" width="100%" height="200"></iframe>
                `

                // Muestro los tramos

            })
        }

        function getHTMLDetallePaquete(data){

            let htmlParadas = ""
            let htmlDuracion = `<i class="me-1 bi bi-sun"></i>1 día`
            
            let totalParadas = data.totalAlojamientoConsulta
            if(totalParadas) htmlParadas = `<p class="m-0"><i class="me-1 bi bi-building"></i>${totalParadas} parada${totalParadas > 1 ? "s" : ""}</p>`

            if(data.paquete.noches > 0) htmlDuracion = `<i class="me-1 bi bi-moon-fill"></i>${data.paquete.noches} noche`+(data.paquete.noches > 1 ? "s" : "")
            
            let [anioSalida, mesSalida, diaSalida] = data.fecha.split("-")
            const fechaSalida = `${diaSalida}/${mesSalida}/${anioSalida}`
            const horaSalida= data.paquete.horaSalida.substring(0,5) 

            return `
                <div class="contentImagePrincipal text-center">
                    <img src="../${data.paquete.imagen}" alt="imagen ${data.paquete.titulo}" width="100%" height="400" style="object-fit: cover; object-position: top; border-top-left-radius: 5px; border-top-right-radius: 5px;">
                </div>
                <div class="p-3">
                    <div class="headerDetalle">
                        <h5 class="fs-2 m-0">${data.paquete.titulo}</h5>
                        <p class="fs-5 m-0 text-secondary">${data.paquete.subtitulo}</p>
                        <hr class="m-0 p-0">
                    </div>
                    <div class="bodyDetalle flex-fill mt-2">
                        <p class="m-0"><i class="me-1 bi bi-globe-americas"></i>${data.paquete.provincia}, ${data.paquete.destino}</p>
                        <p class="m-0"><i class="me-1 bi bi-people"></i>${data.pasajeros} pasajero${(data.pasajeros > 1 ? "s" : "")}</p>
                        ${htmlParadas}
                        <p class="m-0">${htmlDuracion}</p>
                        <p class="m-0"><i class="me-2 bi bi-cup-hot"></i>${data.paquete.pension}</p>
                    </div>
                    <div class="footerDetalle mt-2">
                        <p class="m-0 fs-4">Fecha de salida</p>
                        <p class="mb-2 display-5">${fechaSalida} <span class="fs-4">${horaSalida}hs</span></p>

                        <button class="btn btn-primary btn-sm mt-1" type="button" onclick="handlerRefreshRecorrido()"><i class="bi bi-arrow-repeat me-1"></i>Actualizar recorrido</button>

                        <button type="button" class="btn btn-success btn-sm mt-1" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMensajes" aria-controls="offcanvasMensajes"><i class="bi bi-chat-right-text me-1"></i>Chat general</button>
                    </div>
                </div>
            `
        }
        
        function handlerRefreshRecorrido(){
            Swal.fire({
                title: "¿Estás seguro?",
                text: "Si realiza esta acción perdera todos los cambios realizados en las paradas.",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Si, estoy seguro",
                cancelButtonText: "No"
            }).then((result) => {
                if (!result.isConfirmed) return

                fetch("../admin/process.php?action=recorrido_update&idRecorrido="+paramsURL.idRecorrido)
                .then(res => res.json())
                .then(({status, title, message, type}) => {
                    Swal.fire(title, message, type).then(result => {
                        if(status === "OK") location.reload()
                    })
                })
            });
        }
    </script>
</body>
</html>

